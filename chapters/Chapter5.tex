% !Mode:: "TeX:UTF-8"

\chapter{系统实现}
按照前一章的设计，本章给出每个功能模块的具体实现。详细分析关键功能实现流程图，
也包括对关键代码的分析。
\section{代码规范和总体结构}
本数据库系统采用和JAVA语言类似的
Kotlin语言开发。JAVA中的代码以包为组织单位，
这样组织代码的好处是逻辑结构分明。表\ref{codepdf/allpackage}描述了本系统所有的包
和每个包的详细功能。
其中每个包实现具体的功能，这样分配代码在大型工程实践中很常见。
除了逻辑清晰，方便管理以外，同时也方便团队协作。
\pictable[htbp]{本系统所有包和各个包的作用}{}{codepdf/allpackage}
在所有包里面，config包没有实现具体的功能，这个包主要包括了系统常用的配置信息。
图\ref{codepdf/config}给出了config包下面每个类的具体作用，这个包主要是让用户可以配置
数据库的各个方面，比如配置数据库的端口号，配置最大的连接数等等。
\pictable[htbp]{config包下面每个类的作用}{}{codepdf/config}
在本章的后面会给出其他其他功能模块的详细实现。
\section{客服端功能实现}
客服端主要实现负载均衡功能，利于JDBC连接后端的分布式数据库，
利用网络连接到分布式管理节点得到分布式数据库节点
的IP地址。在分布式管理节点为客服端返回正确数据库地址以后，
客服端就可以通过JDBC连接数据库节点。
客服端连接功能流程图如图\ref{pic5/kefuduan}所示。
\pic[htbp]{客服端连接功能流程图}{}{pic5/kefuduan}

首先，判断客服端有没有已经登录的会话，如果已经有已经登录的会话，那么就可以直接和对应的分布式数据库节点连接。
发送数据库命令并且得到返回结果。当客服端没有连接会话的时候，客服端就首先连接分布式管理节点，分布式管理为客服端返回合适的
数据节点地址，然后客服端利用这个地址再连接数据库服务器。
通过这样一个步骤，分布式管理节点能利用合适的负载均衡算法为客服端选择合适的数据库节点，有利于服务器资源的均衡利用。
\section{分布式管理节点实现}
管理节点实现了负载均衡功能，实现了布式数据库节点的均衡使用。同时也为管理员提供管理和监控功能。
本节主要对分布式管理节点的负载均衡的实现进行说明。
分布式管理节点负载均衡算法示意图如图\ref{pic5/guanli}所示。在接收到客服端的连接请求以后，分布式管理节点首先
需要删除当前客服端之前的所有会话信息，同时更新响应的分布式节点的元数据。然后管理节点利用管理员
设置的负载均衡算法和元数据节点信息计算出选择的节点地址。最后通过网络接口返回给客服端地址。
\pic[htbp]{分布式管理节点负载均衡算法示意图}{}{pic5/guanli}
\section{数据库系统实现}
数据库系统功能在是分布式数据库节点中最重要的
功能模块，提供数据的更删改查的功能。
在源代码实现里面，
SQL包下面的类主要是作为数据库系统管理类，
让用户启动数据库服务器或者关闭数据库服务器。
表\ref{codepdf/sql}描述了SQL包下每个类的作用。
\pictable[htbp]{SQL包的每个类的作用}{}{codepdf/sql}
其中SpringMain类是数据库系统功能的入口，这个类主要调用其他模块，完成数据库系统的启动。
ShutdownMain类用来关闭数据库系统。
按照客服端请求信息的处理流程，
数据库功能模块主要包括网络模块，SQL解析模块和存储引擎模块，
下面分别描述每个模块具体的实现。
\subsection{网络模块}
在网络模块，处理网络套接字的连接和网络字节的处理。
在分布式数据库节点接收到客服端的套接字连接请求以后，
网络模块服务器端套接字接收请求，完成三次握手建立连接以后。交个Netty来处理。
网络字节处理模块主要是用了Netty来实现的，所有和网络字节处理有关的代码都在netty包下面。表\ref{codepdf/netty}描述了每个类的
功能。
\pictable[htbp]{网络模块中各个类的作用}{}{codepdf/netty}
在接收到客服端套接字连接以后，客服端信息会依次经过下面四个类的处理：
\begin{enumerate}
	\item ByteToMysqlDecoder
	\item ByteToMysqlPacket
	\item MysqlPacketHander
	\item NettyServer
\end{enumerate}
具体处理流程如图\ref{pic5/wangluo}所示。
\pic[htbp]{网络模块功能图}{}{pic5/wangluo}
网络模块收到客服端的套接字连接以后需要包网络字节包装成Mysql的消息包格式，如果错误就说明客服端不是我们的客服端或者客服端发送了其他的错误。当截取到消息包格式以后，还需要解析成我们的数据结构，如果解析成功就包数据结构发送到解析模块，如果解析错误，就断开连接。

除了实现网络模块以外，我们还要实现通信协议，系统
采用了和mysql一样的通信协议，在mysql包下面实现了mysql的通信协议。
表\ref{codepdf/mysql}给出了实现通信协议所用到的所有的类。
\pictable[htbp]{通信协议实现所用到的类}{}{codepdf/mysql}

网络服务器接受到客服端的连接以后，就要解析mysql的通信协议，
把每一个消息包封装到具体的对象里面，表\ref{codepdf/mysqlmysql}描述了所有的mysql通信协议的封装对象。
\pictable[htbp]{mysql所有协议包的封装对象}{}{codepdf/mysqlmysql}
mysql协议里面有很多的包，每个协议包都
需要一个类来实现，图\ref{pic5/woshou}是握手包的类图，
\pic[htbp]{握手包实现类图}{}{pic5/woshou}
其他包的实现大体相同，所以在这里不再重复说明。

解析到协议包以后我们就要对协议包进行处理，
协议包的主要有两个阶段，一个是认证阶段，一个是命令阶段，认证阶段就是
接受客服端的请求，然后检查用户的认证信息，比如用户名和密码，
图\ref{pic5/renzheng}显示了认证流程过程。
\pic[htbp]{认证流程图}{}{pic5/renzheng}
如果认证成功以后，就建立连接会话，然后客服端就可以进行向服务器发送命令请求向分布式数据库节点处理数据。
如果失败失败就返回给客服端失败原因。
认证成功以后就是命令阶段，服务器接受客服端的命令，然后处理，
图\ref{pic5/mingling}显示了命令处理流程。
\pic[htbp]{命令处理流程图}{}{pic5/mingling}
在接收到客服端的命令请求以后，网络模块就会调用下面模块的功能接口来对这个命令进行处理。
如果命令处理过程中没有发生异常，那么就把命令处理结果发送给客服端，如果命令处理工程中发送了异常，就返回失败原因。
\subsection{SQL解析模块}
经过网络模块的处理，我们建立了客服端的连接会话，接下来我们就要对客服端发送过来的命令进行判断，如果是SQL命令，就要对这个命令进行解析，进行词法分析，语法分析和语意检查。
在代码实现中，sql包下面的类主要完成对客服端连接和会话的封装和管理，表\ref{codepdf/jsqlsql}显示了sql包下面每个类的具体作用。
\pictable[htbp]{SQL前端连接模块相关的类}{}{codepdf/jsqlsql}
在sql解析功能模块里面系统用到了druid开源框架，用来解析sql，解析sql以后就要做具体的数据处理，
图\ref{pic5/sqlchuli}显示了SQL模块的处理流程图。
\pic[htbp]{SQL处理流程图}{}{pic5/sqlchuli}
在sql解析流程中，如果遇到Druid框架不支持的语句，我们就要自己对这个语句进行解析。再这个工程中。任何一个步骤发送错误就返回错误信息给客服端。不然就进行发送给下一个功能模块进行具体的数据操作。
mysql当中的sql语句有很多种，每一种语句都要做不同的处理，
\ref{codepdf/sqljiexi}描述了sql模块下实现的各种类型的
语句。
\pictable[htbp]{SQL模块下实现的各种类型的语句}{}{codepdf/sqljiexi}

每一种类型语句下面又回有很多种具体语句的实现，表\ref{codepdf/sqlddm}给出了数据
操纵类型语句实现的所有相关的类和响应的功能。
其他类型的语句也需要进行相同的处理，这里就不再进行详细表述。
\pictable[htbp]{数据操纵数据实现所相关的类}{}{codepdf/sqlddm}
\subsection{存储引擎模块}
存储引擎有关的功能主要在storage包下面实现，表\ref{codepdf/storage}给出了
storage包下面各种文件的功能。
\pictable[htbp]{storage包下面各种文件的作用}{}{codepdf/storage}
其中DB类作为底层存储引擎的接口，他的功能接口如表\ref{codepdf/db}所示。
\pictable[htbp]{数据库存储引擎的函数接口}{}{codepdf/db}
和表有关的功能接口如表\ref{codepdf/table}所示。
\pictable[htbp]{数据库引擎和表有关功能的接口}{}{codepdf/table}

存储引擎利用非关系型数据存储，为上面模块提供操作接口。其中有关数据库操作的类接口如图\ref{pic5/db}b所示，有关表操作的类接口如图\ref{pic5/table}所示。
类的实现主要是封装了OrientDB存储引擎的功能，为上一次提供关系操作的接口。在关系数据库中，操作接口就是SQL语言。JSQL因为选择了兼容Mysql协议，所以实现了大部分的Mysql语句功能。这样上层功能模块就可以当做Mysql一样的使用本数据库引擎。
\pic[htbp]{数据库操作接口类图}{}{pic5/db}
\pic[htbp]{表操作接口类图}{}{pic5/table}
\section{集群架构的实现}
集群功能主要是利用了开源的hazelcast框架来实现，
其中的功能全在hazelcast包下面实现，表\ref{codepdf/hazelcast}给出了
该包下面每个类的具体的作用。
\pictable[htbp]{集群模块下面各个类的作用}{}{codepdf/hazelcast}
其中最关键的代码如下。

\input{codetex/MyHazelcast.kt.tex}

\section{数据审计模块的实现}
JSQL除了结合关系数据库和非关系型数据库以外，还从数据库的底层考虑数据的安全问题，对数据审计功能进行了简单的实现，在代码实现中，
审计模块有关的功能全部在audit包下面实现，
表\ref{codepdf/audit}给出了audit包下面
每个类的具体的作用。
\pictable[htbp]{audit包下面每个类的作用}{}{codepdf/audit}
其中LoginLog和SQLlog类主要封装了两种日志类型，一种是客服端的登录记录日志，一种是客服端的命令执行日志。
通过封装这两种日志记录，很容易的就可以实现审计数据的收集和发送功能。
图\ref{pic5/shenji}显示了审计功能演示图。
\pic[htbp]{审计功能演示图}{}{pic5/shenji}
审计功能主要包括审计数据库，审计管理器和审计可视化功能模块，下面分别对每个模块进行说明
\begin{enumerate}
	\item 审计数据库\\
	审计数据库用Elasticsearch来实现，
	作为审计数据库，不能让用户随意的更改，
	所以本系统更改了它的源代码，使得它只能增加数据和查找数据
	不能更改和删除数据。其中主要存储的对象如图\ref{codepdf/audit}所示。
	\item 审计管理器\\
	审计管理功能全部在audit下面实现，主要是存储本地的日志文件，
	然后发布到审计数据库。
	提供给前端可视化的接口。
	\item 审计可视化模块的实现\\
	审计可视化模块的实现用到了grafana，
	主要用来监控ELK中的数据。管理员通过连接分布式管理节点可以对审计数据进行查询。从而对数据的更改情况进行掌控。
\end{enumerate}
\section{本章小结}
本文前面一章设计了本系统的架构图和各个模块的详细功能，本章给出
每个功能模块的具体实现。。