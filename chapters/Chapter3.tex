% !Mode:: "TeX:UTF-8"

\chapter{系统分析}
分析、设计、开发和测试是软件开发的不同阶段。分析包括需求分析和实现技术分析和选择。软件系统采用的技术是系统设计和实现的重要基础。因为不同的技术需要不同的设计，不同的实现过程。
系统需求分析在软件开发生命周期中起到了非常重要的作用，任何一个软件系统在开始设计、开发和测试步骤之前，都必须要明确所开发系统的功能，并用文字记录下来，一旦需求分析出现错误，这将会为后面的开发过程带来非常大的麻烦，需求分析的目的就是明确系统的功能和性能要求\citeup{biexiaofan2013}。系统设计是描述如何实现需求分析中的功能，
给出系统的架构和模块划分图，可见，没有经过仔细的系统分析就不能做好后面的系统设计和编码工作。
本章对分布式数据库JSQL进行分析，包括需求分析和技术分析。在对系统进行需求分析以后，本章后面对各个功能模块的技术进行了阐述及分析。
\section{系统需求分析}
需求分析是站在系统使用者的角度上，把系统当作一个黑盒子，分析系统需要满足用户的功能，不需要考虑系统功能实现细节。在对系统功能分析完成以后，需要把分析的结果记录下来，为后面的软件设计提供基础。
\subsection{系统功能分析}
论文设计和开发的分布式数据库系统，主要是存储大量不同数据类型的数据，所以需要结合关系型数据库和非关系型数据库的优点，系统能够存储不同模式的数据，还能够扩展分布式系统的读写性能，在所有上面这些功能之上，还必须保证存储在分布式数据库系统中数据的安全。本论文所设计和开发的分布式数据库系统JSQL的主要功能
有如下几点：


	\begin{enumerate}
		\item 负载均衡
	\end{enumerate}


	论文所述的分布式系统具有负载均衡功能，目的是为了实现分布式系统中每个集群数据库节点的资源的合理均衡分配。为了实现负载均衡功能，论文采用了分布式管理节点，负载均衡是分布式管理节点的主要功能。其为客户端选择合适的后端分布式数据库几点，从而达到负载均衡的效果。
	分布式管理节点只是一个功能节点，其上实现分布式负载均衡算法，为客户端选择合适的后端服务器，同时其也能提供后端数据库存储功能。
	
	\begin{enumerate}[resume]
		\item 数据存储管理
	\end{enumerate}

	论文所述系统作为一个数据库系统，其应该具有存储和管理数据的能力。论文所述分布式数据库系统结合关系数据库和各种非关系数据库的优点，能够存储关系型数据库和其他非关系型数据类型。
	对用户来说，本系统提供的功能接口和关系型数据库接口是一样的，也就是就是SQL接口，
	更准确的说，是Mysql接口，所以系统应该提供关系型数据库常用的功能。
	同时本系统利用非关系型数据库OrientDB存储，实现数据的高效存储和访问，利用数据库集群实现数据库
	存储功能的可靠性。
	
	\begin{enumerate}[resume]
		\item 数据库系统监控和维护
	\end{enumerate}

	JSQL系统在分布式管理节点和分布式数据库节点的结合下，从数据库的底层实现了数据库的安全审计的功能。
	在分布式管理节点，实现了审计监控的界面功能，管理员通过管理计算机连接分布式管理节点就可以对数据库进行管理和维护
	。同时也能进行监控报警功能的设置。而监控日志等信息存储在数据库引擎内部，保证监控数据的可靠安全。


	从节点功能上分配上，分布式数据库系统JSQL可分为两
	部分，提供负载均衡功能和管理监控功能的分布式管理节点，提供数据存储和管理的数据库基本功能的分布式数据库集群节点。
具体的，提供的数据库功能主要包括：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 数据定义：分布式数据库系统能提供数据定义功能，数据定义能让用户定义数据模型结构。数据定义保存在数据库字典中。因为本文阐述的是一个多模型数据库，其数据定义相当灵活，可以定义字段，也可以以后增加和删除字段。
	\item 数据操作：分布式数据库系统提供数据操作功能
	，供用户实现对数据的追加、删除、更新、查询等操作。用户通过接口向分布式数据库系统发送命令，获取数据操作结果，一般的操作结果采用传统的SQL语言。
	\item 系统运行控制：分布式数据库系统系统运行控制功能是维持分布式数据库系统正常运行的控制和操纵功能
	，包括多用户环境下的并发控制和安全管理，这些功能是系统正确运行的基础。
	\item 数据组织：数据库系统中的数据组织功能是选择数据在底层硬件的存储格式。
	不同的数据库系统可以选择不同的存储引擎，存储引擎选择合适的数据结构来存储组织数据，使得数据可以被高效的访问。选择合适的算法压缩数据也可以进一步的减少数据的存储空间占用。
	\item   数据保护：数据是所有应用程序运行的基础，保证数据的安全是数据库的重要功能。数据保护的目标是防止数据出现破坏或者丢失，比如防止数据库中出现不一致的数据，防止人为修改数据，在系统故障的时候可恢复数据。
	\item  数据库的维护：这一功能主要是对数据库系统本身进行监控和管理，使得其一直保持在最佳的状态，这样才能使得数据库系统的性能在最高水平，保证系统数据的安全。数据库维护一般是数据库系统软件以外的工具软件完成，也可以由第三方软件公司开发作为工具软件使用，使得更加容易维护数据库系统。
\end{enumerate}
\subsection{系统功能用例}
用例图用来描述系统用户和系统的关系。一个用例图包括系统功能用例图，系统的每个
用例代表系统的一个功能\citeup{biexiaofan2013}。用例描述的是系统的功能，是站在系统的使用者的角度描述功能，
不是描述系统内部功能实现细节。站在用户的角度上，分布式数据库系统应该能够对存储在其中的数据进行增删改查等操作
。系统总体的用例图如图\ref{pic3/xuqiufenxi}所示。

\pic[htbp]{系统用例图}{}{pic3/xuqiufenxi}
在论文所述分布式数据库系统中，其主要功能就是对数据进行存储和处理，具体的有对数据的新增、删除、修改和查询。下面对这几种功能进行具体说明。
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 新增数据就是在数据库中增加一条记录，用户向系统发起新增数据请求，数据库系统在数据库中存储新的记录。
	具体用例如表\ref{pic3/xinzeng}所示。
	\pictable[htbp]{新增数据用例描述}{}{pic3/xinzeng}
	\item 数据查询是通过记录的其中一个关键属性查询其整个记录的操作，用户一般是用SQL语言向数据库系统表达命令请求。具体用例如表\ref{pic3/chaxun}所示。
		\pictable[htbp]{查询数据库数据用例描述}{}{pic3/chaxun}
\item 当数据不再需要存储的时候，用户可以向数据库系统发送删除数据的命令，数据库系统将从底层把数据记录删除掉，其用例具体描述如\ref{pic3/shanchu}所示。
		\pictable[htbp]{删除数据库中已有数据用例描述}{}{pic3/shanchu}
\item 	修改数据是指当用户需要更加记录的一些属性的时候，向数据库发送修改请求，底层数据库把新的属性存储在数据库系统中，用例详细描述如表\ref{pic3/xiugai}所述。
	\pictable[htbp]{修改数据用例描述}{}{pic3/xiugai}
\end{enumerate}
\section{技术和框架分析}
\subsection{系统实现语言选择}
本数据库系统选择了JAVA语言和KOTLIN语言作为开发语言，
之所以这样选择，主要基于以下几个原因：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item JAVA是跨平台的开发语言，用JAVA开发实现数据库系统，
	可实现所有主流平台的数据库部署，方便数据库系统在不同系统间迁移。
	\item JAVA是企业开发的首选语言，其安全性比本地语言更高。用C等本地语言开发系统，虽然性能比较好，但是很容易出现内存泄漏，容易被攻击。作为企业开发语言，JAVA开发的软件更加容易维护，不容易出错误，也就更安全。
	\item 本系统实现相关的非关系型数据库引擎OrienDB和Elasticsearch也是用JAVA开发的，为了方便集成它们。本系统也应该使用同一种开发语言。
	\item JAVA易于开发和调试，作为学生时期个人开发的数据库系统，
	一个人的精力是有限的，如何选择高效的开发工具和语言对我们来说非常重要。
\end{enumerate}
\subsection{网络实现技术分析}
所有的服务器软件都需要实现网络模块，这样才能接受客户端的连接请求。
JSQL用java语言开发，主要用到的是java语言的网络开发技术。

在JAVA网络开发技术中，网络IO的方式分为同步阻塞、
同步非阻塞和异步非阻塞方式。

在网络编程里面，同步阻塞是最简单的编程模型。在这个模型中，网络中的服务器端和客户端在收到对面返回结果时都需要等待对方，在等待的时候不能干其他时候。同步就是服务器和客户端的操作序列同步，在前一个步骤没有完成的时候，后面的步骤必须等待，阻塞就是在系统等待的时候，系统阻塞运行，不能运行其他代码。这样对系统的资源是一个浪费。虽然在操作系统中，可以通过多线程来避免大部分问题，但是建立线程是需要代价的，而且操作系统的线程数量是有限的，不能支持成千上万的客户端服务器连接。

NIO编程模型\citeup{Hitchens2002Java}就是为了解决上面同步阻塞编程模式的缺点而发明的，在NIO编程模型中，服务器的一个线程可以处理多个客户端连接事件，在等待客户端返回请求的时候，服务器可以接受来自其他客户端的连接请求。这样一个线程就可以维护多个客户端的连接，增加系统的并发性能。而同步阻塞要完成相同的功能，服务器就必须要使用多线程，而多线程是有开销的。所以NIO提高了高并发服务器的性能。



Netty是用JAVA语言开发的网络框架，其主要目的是建立基于NIO编程模型的高性能协议服务器，用Netty开发网络服务器比直接用Java语言开发更加简单，性能也更高。
Netty的线程模型如如\ref{netty}所示。
\pic[htbp]{Netty}{}{netty}
Netty是一个非阻塞框架。与阻塞IO相比，这可以大大提高系统的吞吐量和并发性能。
Netty使用事件驱动的应用程序范例，在Netty中，网络数据包的处理流水线是一系列事件处理程序，开发人员通过编写自己的事件处理程序就能自己开发网络协议。
因为Netty的这些特效，利用它可以实现一个高性能的网络应用程序，所以本系统的网络模块也是用的Netty来
实现的，它支持高并发的客户端访问。
\subsection{通信协议分析}
每个服务器和客户端通信都要实现自己的通信协议，在本论文所述分布式系统中，结构化存储需要用到SQL操作需要，就需要实现关系型数据库网络协议，考虑到Mysql使用的广泛性
，Jsql采用Mysql的通信协议。这样就能支持更多的遗留客户端软件。
在MySQL数据库通信过程中。一共有两个阶段，第一个阶段是在客户端连接服务器的时候，服务器对客户端的身份和权限进行检查，检查成功以后连接才会进行，服务器才会让客户端进行下一个阶段。mysql通信的基本单位是应用程序包。
多个指令可以合成一个包；答复可以包含多个包。
MySQL客户端与服务器的交互过程主要有两个阶段：握手认证阶段和命令执
行阶段：
\begin{enumerate}
	\item 握手认证阶段\\
	在客户端通过网络接口连接服务器的时候，握手阶段就开始了，其交互过程如下：
	\begin{enumerate}
		\item 服务器发送给客户端握手初始化报文。
		\item 客户端回复服务器端登陆认证报文。
		\item 服务器发送给客户端认证结果报文。
	\end{enumerate}
	\item 命令执行阶段\\
	在握手阶段，服务器对客户端进行身份和权限检查，所有检查通过以后就会进入命令阶段，命令阶段客户端服务器交互过程如下：
	\begin{enumerate}
		\item 	客户端发送服务器执行命令报文。
		\item 服务器发送给客户端命令执行结果。
	\end{enumerate}
\end{enumerate}
MySQL客户端和服务器之间在网络通信中完整的交互过程如图\ref{mysqljh}所示。
\pic[htbp]{协议交互流程图}{}{mysqljh}

通过实现mysql通信协议，分布式数据库系统使用者可以用mysql的所有客户端连接本系统，存储结构化数据。在实现mysql协议的同时，也需要对二进制协议进行接口定义，以便用户可以存储其他数据类型的数据。系统选择实现mysql协议，是因为mysql是最广泛使用的免费的数据库系统，其用户非常之多，实现mysql协议以后，mysql的所有工具和客户端都可以直接连接JSQL分布式数据库系统。
\subsection{SQL实现分析}
SQL是一种通用的数据库操纵语言，数据库和应用程序用户将数据库操作请求发送到数据库服务器，只需要说明操作目的和结果，不需要说明具体操作的执行过程。同样的语句，不同的数据库服务器会选择合适自己存储引擎的执行过程。这样每个数据库服务器就能实现不同的操作过程，实现不同的性能。

在关系数据库系统中，SQL是通用的操作语言，用户和数据库系统通过SQL语句交流数据和发送命令请求。用户发送SQL命令，然后数据库系统解析命令，返回命令结构。
虽然所有的关系数据库系统都支持SQL语句，但是不同的数据库系统支持的语句类型不一定相同。本论文所述的分布式系统选择实现和mysql一样的sql语句。

Mysql支持的sql语句和标准的sql语句不全一样，具体的，它支持下面这几种语句类型：
\begin{enumerate}
\item 数据定义语句     
\item 数据操作语句     
\item 交易和锁定声明     
\item 复制语句     
\item 准备的SQL语句语法     
\item 复合语句语法     
\item 数据库管理语句     
\item 效用声明  
\end{enumerate}   
其中每种语句类型又分为很多种sql语句，所以mysql支持的sql语句非常的多，
因为本系统选择了兼容mysql的协议，所以我们
也要解析这些不同的sql语句，本系统利用Druid框架实现了对SQL语句的解析功能。
其对客户端的命令进行词法分析后语法分析以后，生成预定的JAVA对象格式，这样我们
就能对其进一步的处理。当然，并不是所有的语句都能这样检查的处理，还有其他Druid不支持的
语句，我们只能自己对其进行解析。在对sql语句进行语法解析以后，接下来就需要进行语义分析。
结合分布式数据库系统元数据，对sql语句进行合法性检查。查找适合的数据库存储接口调用。返回客户端结果。
\subsection{存储引擎分析}
在任何数据库系统中，存储引擎都是最重要最难实现的部分，存储引擎设计的好坏直接影响系统的整体性能。
存储引擎决定数据在底层的存储格式，解决数据的并发性和一致性问题。
每种存储引擎底层都基于一种数据结构。比如常用的哈希表结构和B+树结构。
本系统所用的OrientDB存储引擎底层就是用的B+树结构。
利用非关系数据库OrientDB实现可靠的数据存储，结合非关系型数据库的优点，
使得数据库系统更加容易实现集群，更加容易扩展。

和传统关系型数据库系统不同的是，在orientdb存储引擎中，关系是直接存储在每个记录的对象里面的。而在关系数据库系统中，数据之间的关系是通过外键关联的。这样在获取一个记录相关联的时候，就必须去查找另外的一个表记录。这样就会对磁盘进来查找。最严重的就是顺序扫描，其性能非常低下，这也就是为什么关系型数据库在外键很多的时候，性能严重下降的原因。而在orientdb数据库引擎中，要查找一个记录对应的记录，只需要按照记录中记录的地址去查找就可以了。关系直接存储在记录中，不需要再去查找外键。对提高性能非常重要。
\subsection{分布式架构分析}
数据库系统的分布式架构决定其扩展性，在传统的关系型数据库系统中，要扩展数据库系统的性能，一般
通过复制主从架构，其能扩展读取性能，但是不能提高系统的更新性能。
虽然现在很多NOSQL数据库都实现了分布式，但是本系统还是利用Hazelcast
自己开发了分布式功能，论文所述分布式数据库系统实现的是多主分布式架构，每个集群节点都是主节点，都可以
接受更新请求，这样就能扩展更新能力。

Hazelcast是一个用JAVA语言开发的开源的内存数据网格框架，提供了一些在分布式系统中非常重要的基础功能，包括：
\begin{enumerate}
	\item 集群节点发现和选举
	\item 分布式数据结构
\item 	分布式计算
	\item 分布式查询
	\item 聚类
	\item 高速缓存
	\item 多语言绑定
\item 	轻松嵌入到Java应用程序中
\end{enumerate}

这些功能使Hazelcast成为应用程序中的多用途工具。
它可以用来作为非关系型数据库系统，能存储多种结果的数据，
还可以用来解决分布式应用程序中的多个问题。Hazelcast从一开始就被设计为一个分布式内存网格框架，
解决了主选举、网络弹性以及最终一致性等许多潜在的难题
。在Hazelcast框架中，提供了很多分布式的数据结构，利用这些分布式数据结构可以开发分布式数据库系统，这个框架用JAVA语言开发，能在多个平台部署，利用Hazelcast可以轻松开发出
稳定可靠的分布式集群功能。
\subsection{监控审计分析}
监控功能主要在分布式管理节点部署，管理员通过连接分布式管理节点，就能对分布式数据库进行监控。
对数据进行操作。
本系统实现最简单的监控模块，一个监控模块首先要存储
所有的日志数据，而且这个数据不能随意的更改，所以我改了Elasticsearch的源代码，
让它来存储所有的sql更新日志信息，其中的日志信息不能被篡改和删除，同时对其进行分析和统计，
然后用可视化的框架来显示出结果。
之所以用这个框架，主要是因为它是一种搜索引擎，能够非常快速的检束出我们需要的各种信息，
这对于信息审计来说非常的重要。利用这个框架我们实现了实时的安全审计功能，提高了数据库的安全性。
\section{本章小结}
在这一章中，对所述分布式数据库系统进行了需求分析和技术分析。
需求分析是指分析系统的功能和性能要求，本论文所述分布式数据库系统作为一个数据库系统，其具有存储和操纵数据的功能。在对系统进行需求分析以后，论文分析了系统每个功能模块所需要的技术，
每个模块的实现都要用到不同的技术，
对每种技术进行了分析。