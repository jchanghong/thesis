% !Mode:: "TeX:UTF-8"

\chapter{系统分析}
系统需求分析
的工作阶段是软件开发过程的开始阶段，是软件生命周期中
的一个重要环节，对于整个软件开发过程以及软件产品的质量是至关重要的，因
为构建软件系统最艰难的一个部分就是准确的决定要构建什么，没有其他的概念
性工作像建立详细的技术需求这样难，包括所有对人的界面、对机器的接口、以
及对其他软件系统的接口。如果做错了会对最终系统造成相当大的损害，并且后
期难以调整。而后面的设计只是是将问题转换为解决方案的的创造性过程，
系统设计是在系
统分析的基础上研究系统如何实现需求中所描述的功能，给出满足需求的解决方
案，可见，没有经过仔细的系统分析就不能做好后面的系统设计和编码工作。
本章的主要内容是介绍分布式数据库系统的需求分析，需求分析
主要包括整个系统的需求分析与功能分析，同时也包括了对各个功能模块的实现分析。
\section{系统需求分析}
需求阶段的目标是理解客户的问题和需要，需求分析是在综合分析用户对系
统提出的一组需求（功能、性能、数据等方面）的基础上，构造一个从抽象到具
体的逻辑模型表达软件将要实现的需求，并以“软件需求规格说明书”的形式作
为本阶段工作的结果，为下一阶段的软件设计提供设计基础。
\subsection{系统功能需求}
本论文所研究的分布式数据库系统，主要对大数据量进行高效处理，需
要系统具备大容量存储和高速率运算。传统的关系数据库在应付日益增长的大量
数据时暴露了越来越多难以克服的问题，而现在的各种NOSQL数据虽然支持
大量数据的存储，但是对关系的操作又很少。因此，本文结合关系型技术与分
布式NOSQL技术，来设计能够对大量数据进行高效处理的分布式数据
库系统。作为项目的前期工作，本文所设计的分布式数据库系统的主要功能
如下：


	\begin{enumerate}
		\item 提供负载均衡功能
	\end{enumerate}

	本文所述的分布式系统，为了实现系统中各个数据库节点的负载均衡，
	需要系统具有良好的分散性，即客户端发送的请求消息能够均匀的发送到各
	数据库节点。因此本文提出了分布式管理几点，该几点的功能构成本文
	的分布式管理模块的主要功能，其为客服端选择合适的后端分布式数据库几点，从而达到负载均衡的效果。
	分布式管理节点只是一个功能节点，其上实现分布式负载均衡算法，为客服端选择合适的后端服务器，同时其也能提供后端数据库存储功能。
	
	\begin{enumerate}[resume]
		\item 提供数据库功能
	\end{enumerate}

	站在客户的角度，需要本系统能够提供增加、删除、修改、查询等数据库基
	本功能操作。本文结合非关系型数据库和关系数据库技术。实现了一种分布式数据库系统。
	对用户来说，本系统提供的功能接口和关系型数据库接口是一样的，也就是就是SQL接口，
	更准确的说，是Mysql接口，所以系统应该提供关系型数据库常用的功能。
	同时本系统利用非关系型数据库OrientDB存储，实现数据的高效存储和访问，利用数据库集群实现数据库
	存储功能的可靠性。
	
	\begin{enumerate}[resume]
		\item 提供管理监控功能
	\end{enumerate}

	JSQL系统在分布式管理节点和分布式数据库节点的结合下，从数据库的底层实现了数据库的安全审计的功能。
	在分布式管理节点，实现了审计监控的界面功能，管理员通过管理计算机连接分布式管理节点就可以对数据库进行管理和维护
	。同时也能进行监控报警功能的设置。


	因此，基于对整个分布式数据库系统的功能需求的分析，系统可分为两
	部分，提供负载均衡功能和管理监控功能的分布式管理节点，提供增加、删除、
	修改、查询等数据库基本功能操作的数据库节点。
具体的，提供的数据库功能主要包括：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 数据定义：系统提供数据定义语言DDL，供用户定义数据库的三级模式结构、两级映像以及完整性约束和保密限制等约束。
	DDL主要用于建立、修改数据库的库结构。DDL所描述的库结构仅仅给出了数据库的框架，
	数据库的框架信息被存放在数据字典中。
	\item 数据操作：系统提供数据操作语言DML
	，供用户实现对数据的追加、删除、更新、查询等操作。
	\item 数据库的运行管理：数据库的运行管理功能是系统的运行控制、管理功能
	，包括多用户环境下的并发控制、安全性检查和存取限制控制、
	完整性检查和执行、运行日志的组织管理、事
	务的管理和自动恢复，即保证事务的原子性。这些功能保证了数据库系统的正常运行。
	\item 数据组织、存储与管理：系统要分类组织、存储和管理各种数据，
	包括数据字典、用户数据、存取路径等，需确定以何种文件结
	构和存取方式在存储级上组织这些数据，如何实现数据之间的联系。
	数据组织和存储的基本目标是提高存储空间利用率，选择合适的存取方法提高存取效率。
	\item   数据库的保护：数据库中的数据是信息社会的战略资源，所以数据的保护至关重要。系统
	对数据库的保护通过4个方面来实现：数据库的恢复、数据库的并发控制、数据库的完整性控制
	、数据库安全性控制。系统的其他保护功能还有系统缓冲区的管理以及数据存储的某些自适应调节机制等。
	\item  数据库的维护：这一部分包括数据库的数据载入、转换、转储、数据库的重组合重构以及性能监控等功能，这些功能分别由各个使用程序来完成。
	\item 通信：系统具有与操作系统的联机处理、分时系统及远程作业输入的相关接口，负责处理数据的
	传送。对网络环境下的数据库系统，还应该包括系统与网络中其他软件系统的通信功能以及数据库之间的互操作功能。
\end{enumerate}
\subsection{系统功能用例}
用例图用于描述一组用例、参与者及它们之间的连接关系。一个用例描述了
一组动作序列，每一个序列表示系统的外部设施（系统的参与者）与系统本身的
交互。本系统的用例图是从参与者使用系统的角度来描述系统中的信息，即站在
系统外部查看系统应该具有何种的功能，而不是描述功能在系统内是如何实现
的。本文设计的分布式数据库系统的主要功能为新增数据、查询数据、修改
数据、删除数据。系统总体的用例图如图\ref{pic3/xuqiufenxi}所示。

\pic[htbp]{系统用例图}{}{pic3/xuqiufenxi}
分布式数据库的主要功能用例为新增数据、查询数据、修改数据、删除
数据等，下面对这几种操作的用例进行说明。
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 新增数据是用户从客户端向系统发起新增数据请求，
	具体用例见表\ref{pic3/xinzeng}。
	\pictable[htbp]{新增数据用例}{}{pic3/xinzeng}
	\item 数据查询是指利用用户在客户端上输入指定数据标识作为关键字，查询
	该条数据的基本信息，具体用例见表\ref{pic3/chaxun}。
		\pictable[htbp]{查询数据用例}{}{pic3/chaxun}
\item 	删除数据是指当数据无效时，客户端发送删除信息请求分布式数据
	库系统删除该条数据，具体用例见表\ref{pic3/shanchu}。
		\pictable[htbp]{删除数据用例}{}{pic3/shanchu}
\item 	修改数据是指当数据需要修正时，管理员通过客户端发送修改消息请求，
	通知分布式数据库系统存入新数据
	，刷新数据变化部分，具体用例见表\ref{pic3/xiugai}。
	\pictable[htbp]{修改数据用例}{}{pic3/xiugai}
\end{enumerate}
\section{技术和框架分析}
\subsection{系统实现语言选择}
本数据库系统选择了JAVA语言和KOTLIN语言作为开发语言，
之所以这样选择，主要基于以下几个原因：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item JAVA是跨平台的开发语言，用JAVA开发实现数据库系统，
	可用实现所有主流平台的数据库部署。
	\item JAVA是企业开发的首选语言，其安全性比本地语言更高。
	\item 非关系型数据库引擎OrienDB也是用JAVA开发的，为了方便调用。本系统也应该使用同一种语言。
	\item JAVA易于开发和调试，作为学生时期个人开发的数据库系统，
	一个人的精力是有限的，如何选择高效的开发工具和语言对我们来说非常重要。
\end{enumerate}
\subsection{网络实现技术分析}
所有的服务软件都需要实现网络模块，这样才能连接客服端的请求。
JSQL用java语言开发，主要用到的是java的网络开发模块。

网络IO的方式通常分为同步阻塞的BIO、同步非阻塞的NIO和异步非阻塞的AIO\citeup{thesis20}。

在JDK1.4出来之前，我们建立网络连接的时候采用BIO模式，
需要先在服务端启动一个ServerSocket，
然后在客户端启动Socket来对服务端进行通信，
默认情况下服务端需要对每个请求建立一堆线程等待请求，
而客户端发送请求后，先咨询服务端是否有线程相应
，如果没有则会一直等待或者遭到拒绝请求，如果有的话，客户端会线程会等待请求结束后才继续执行。

NIO本身是基于事件驱动思想来完成的
，其主要想解决的是BIO的大并发问题：
 在使用同步I/O的网络应用中，如果要同时处理多个客
 户端请求，或是在客户端要同时和多个服务器进行通讯
 ，就必须使用多线程来处理。也就是说，将每一个客户端
 请求分配给一个线程来单独处理。这样做虽然可以达到我们
 的要求，但同时又会带来另外一个问题。由于每创建一个线程
 ，就要为这个线程分配一定的内存空间（也叫工作存储器），而
 且操作系统本身也对线程的总数有一定的限制。如果客户端的请求过
 多，服务端程序可能会因为不堪重负而
 拒绝客户端的请求，甚至服务器可能会因此而瘫痪。

在高性能的I/O设计中，有两个比较著名的模式Reactor和Proactor模式，
其中Reactor模式用于同步I/O，而Proactor运用于异步I/O操作。
在比较这两个模式之前，我们首先的搞明白几个概念，什么是阻塞和非阻塞
，什么是同步和异步,同步和异步是针对应用程序和内核的交互而言的，
同步指的是用户进程触发IO操作并等待或者轮询的去查看IO操作是否就绪
，而异步是指用户进程触发IO操作以后便开始做自己的事情，而当IO操作
已经完成的时候会得到IO完成的通知。而阻塞和非阻塞是针对于进程在访问
数据的时候，根据IO操作的就绪状态来采取的不同方式，
说白了是一种读取或者写入操作函数的实现方式，阻塞方式下读取或者写入函
数将一直等待，而非阻塞方式下，读取或者写入函数会立即返回一个状态值。

Netty的主要目的是建立基于NIO的高性能协议服务器，分离和松散耦合网络和业务逻辑组件。
它可能会实现一个广为人知的协议，如HTTP或您自己的特定协议。
Netty的线程模型如如\ref{netty}所示。
\pic[htbp]{Netty}{}{netty}
Netty是一个非阻塞框架。与阻塞IO相比，这导致高吞吐量。
Netty使用事件驱动的应用程序范例，因此数据处理的流水线是一系列事件处理程序。

因为Netty的这些特效，利用它可以实现一个高性能的网络应用程序，所以本系统的网络模块也是用的Netty来
实现的，它支持高并发的客服端访问。
\subsection{通信协议分析}
每个服务器和客服端通信都要实现自己的通信协议，考虑到Mysql使用的广泛性
。Jsql采用Mysql的通信协议。这样就能支持更多的遗留客户端软件。
在MySQL数据库通信过程开始时，服务器会使用TCP监听一个本地socket
端口或本地socket链接。当一个客户端的连接请求到达，就会执行握手和权限验
证。如果验证成功，会话开始。客户端发送消息，服务器会以一个适合该发送命
令的数据类型的数据集或一条消息进行回复。当客户端发送完成后，会发送一个
特殊的命令，告诉服务器己发送，然后会话结束。通信的基本单位是应用程序包。
多个指令可以合成一个包；答复可以包含多个包。
MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执
行阶段：
\begin{enumerate}
	\item 握手认证阶段\\
	握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：
	\begin{enumerate}
		\item 服务器发送给客户端握手初始化报文。
		\item 客服端回复服务器端登陆认证报文。
		\item 服务器发送给客户端认证结果报文。
	\end{enumerate}
	\item 命令执行阶段\\
	客户端认证成功后，会进入命令执行阶段，交互过程如下：
	\begin{enumerate}
		\item 	客户端发送服务器执行命令报文。
		\item 服务器发送给客服端命令执行结果。
	\end{enumerate}
\end{enumerate}
MySQL客户端与服务器之间的完整交互过程如图\ref{mysqljh}所示。
\pic[htbp]{协议交互流程图}{}{mysqljh}
\subsection{SQL实现分析}
结构化查询语言是一种特殊的编程语言，
用于数据库中的标准数据查询语言，IBM公司最早使用在其
开发的数据库系统中。1986年10月，美国国家标准协会对SQL进行规范后，以此作为
关系式数据库管理系统的标准语言，
1987年得到国际标准组织的支持下成为国际标准。
不过各种通行的数据库系统在其实践过程中都对SQL规范作了某些编改和扩充。
所以，实际上不同数据库系统之间的SQL不能完全相互通用 ,
 甚至不同版本间也可能无法互通。

SQL是高级的非过程化编程语言，它允许用户在高层数据结构上工作。
它不要求用户指定对数据的存放方法，也不需要用户了解其具体的数据存放方式。
而它的界面，能使具有底层结构完全不同的数据库系统和不同数据库之间，
使用相同的SQL作为数据的输入与管理。

Mysql支持的sql语句和标准的sql语句不全一样，它支持下面这几种语句类型：
\begin{enumerate}
\item 数据定义语句     
\item 数据操作语句     
\item 交易和锁定声明     
\item 复制语句     
\item 准备的SQL语句语法     
\item 复合语句语法     
\item 数据库管理语句     
\item 效用声明  
\end{enumerate}   
其中每种语句类型又分为很多种sql语句，所以mysql支持的sql语句非常的多，
因为本系统选择了兼容mysql的协议，所以我们
也要解析这些不同的sql语句，本系统利用Druid框架实现了对SQL语句的解析功能。
其对客户端的命令进行词法分析后语法分析以后，生成预定的JAVA对象格式，这样我们
就能对其进一步的处理。当然，并不是所有的语句都能这样检查的处理，还有其他Druid不支持的
语句，我们只能自己对其进行解析。
\subsection{存储引擎分析}
存储引擎是存储系统的发动机，直接决定了存储系统能够提供的性能和功能。
存储
系统的基本功能包括：增、删、读、改，其中，读取操作又分为随机读取
和顺序扫描。
每种存储引擎底层都基于一种数据结构。比如常用的哈希表结构和B+树结构。
本系统所用的OrientDB存储引擎底层就是用的B+树结构。
利用非关系数据库OrientDB实现可靠的数据存储，结合非关系型数据库的优点，
使得数据库系统更加容易实现集群，更加容易扩展。
\subsection{分布式实现分析}
虽然现在很多NOSQL数据库都实现了分布式，但是本系统还是利用Hazelcast
自己开发分布式功能。
在计算中，Hazelcast是基于Java的开源内存数据网格。
它也是开发产品的公司的名称。Hazelcast公司由风险投资资助。
在一个Hazelcast网格中，数据被一个均匀的节点之间分配计算机集群，
从而允许水平缩放的处理和可用存储。备份也分布在节点之
间，以防止任何单个节点的故障。Hazelcast通过内存中
访问经常使用的数据和可弹性扩展的数据网格，提供中
央，可预测的应用程序扩展。这些技术减少了对数据库的查询负载，并提高了速度
利用Hazelcast可以轻松开发出各种的分布式应用程序，而且部署非常简单，
只需要嵌入它的二进制包就可以直接使用，避免再部署另外的系统来实现分布式，
所以本系统选择了它来实现分布式的功能。
\subsection{监控功能实现分析}
监控功能主要在分布式管理节点部署，管理员通过连接分布式管理节点，就能对分布式数据库进行监控。
对数据进行操作。
本系统实现最简单的监控模块，一个监控模块首先要存储
所有的日志数据，而且这个数据不能随意的更改，所以我改了Elasticsearch的源代码，
让它来存储所有的sql更新日志信息，其中的日志信息不能被篡改和删除，同时对其进行分析和统计，
然后用可视化的框架来显示出结果。
之所以用这个框架，主要是因为它是一种搜索引擎，能够非常快速的检束出我们需要的各种信息，
这对于信息审计来说非常的重要。利用这个框架我们实现了实时的安全审计功能，提高了数据库的安全性。
\section{本章小结}
本章对分布式数据库系统进行需求分析。首先，站在用户的角度
对系统的需求进行具体的分析，描述系统的功能需求，并结合系统用例图给出功
能用例。然后本章分析了系统每个功能模块所需要的技术，
每个模块的实现都要用到不同的技术，
对每种技术进行了分析。