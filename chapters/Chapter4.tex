% !Mode:: "TeX:UTF-8"

\chapter{系统设计}
在软件开发流程中，需求分析之后就是设计阶段，设计分为总体概要设计和详细设计。首先，开发者需要对
软件系统进行总体概要设计，即总体概要和框架设计。总体概要设计就是设计系统的总体功能，框架设计就是在系统功能的基础上，设计系统的模块，为软件的详细设计提供基础。
在概要设计以后就要对系统的每个模块进行详细设计，详细设计设计每个模块功能实现流程，对每个模块需要的技术和算法进行设计。详细阶段需要对每个模块进行详细的设计，才能根据设计编写代码。
只有经过仔细的系统设计，在编码阶段才能提前减少不必要的错误。
\section{系统总体设计}
\subsection{系统架构设计}
在系统设计中，先进行原型化设计可以对系统整体功能进行大概的说明，有利于对整体的功能把握。
原型化设计就是先构建一个系统的小版本，通常只包括整体功能中有限的功能，突出整体中的关键功能，其可用于：
\begin{enumerate}
	\item 帮助用户和客户标识系统的关键功能需求，忽视具体的细节，从而利于把握整体。
	\item 证明设计或方法的可行性，方便对系统做进一步的总体设计。
\end{enumerate}
通常，原型化设计方法是一个迭代的过程：首先构建一个原型，然后对这个原型进行评估，考虑如何对原型设计进行改进，之后再构建另外一个原
型，如此循环迭代。当客户认为原型解决方案满意时，迭代过程就终止了，可以进一步完成系统的设计工作。
由于本文所涉及的分布式数据库系统功能非常大，结构非常，代码工作量大，
因此采用了原型化模型的软件开发方式开发一个数
据库原型，然后后期逐渐对这个原型进行改进。作为一个分布式数据库系统，系统要实现的首要功能就是数据库的增加、查询、修改、删除等功能，为了对系统进行扩展，论文设计了分布式数据库系统的分布式架构。
当JSQL部署在分布式网络上的时候，系统的网络拓扑结构如图\ref{pic4/bushu}所示。
\pic[htbp]{系统网络拓扑结构图}{}{pic4/bushu}
在系统网络拓扑图中，主要有下面几种节点：


	\begin{enumerate}
		\item 客户端节点
	\end{enumerate}

	客户端节点作为连接分布式数据库服务器的代理，发送SQL命令请求到数据库服务器，请求数据，客户端节点可以是原生的Mysql节点，也可以是自己开发的具有负载均衡的JDBC客户端。如果是用Mysql客户端，就可以直接连接分布式数据库节点，可以任意选择一台分布式数据库节点执行数据库操作命令，其中数据库会自动同步到其他数据库节点。当用自己开发的JDBC客户端的时候，客户端就会首先连接分布式管理节点，得到具体的分布式数据库节点后，才能连接数据库节点执行具体的数据库命令。

	\begin{enumerate}[resume]
		\item 分布式管理节点
	\end{enumerate}

	分布式管理节点管理分布式数据库节点的元数据和实现负载均衡算法。管理计算机通过连接分布式管理节点，可以对分布式节点进行管理，对系统进行监控。这样当客户端请求到来的适合，分布式管理节点就可以返回适合的分布式数据库集群节点，从而达到均衡集群服务器资源的效果。

	\begin{enumerate}[resume]
		\item 分布式数据库节点
	\end{enumerate}

	分布式节点存储具体的数据，数据库系统功能主要在这个节点上面执行，响应客户端的增删改查的命令请求。当客户端连接分布式数据库节点以后，会检查客户端的权限，只有有权限的用户才能执行命令。在JSQL中，每个分布式数据库节点的功能都是独立的，都可以独立运行，管理本地存储的数据。

	\begin{enumerate}[resume]
		\item 管理计算机
	\end{enumerate}

	管理员通过管理计算机管理分布式数据库几点，也可以通过管理计算机来查看审计信息，设置监控报警功能。


在系统网络拓扑结构图中，客户端是数据库系统用户发送命令的终端设备，各个
分布式数据库节点和分布式管理节点构成了系统的服务器端。其中，分布
式管理节点作为中心节点接收所有的控制消息，
通过分布式管理节点才能找到分布式数据库节点的IP地址
。

在图\ref{pic4/bushu}中，客户端是用户向分布式数据库系统发送数据操纵命令的软件。分布式管理节点实现分布式负载均衡算法，把客户端的请求均衡的分配到每个分布式数据库节点上面去，分布式数据库节点则是存储数据的服务器节点。
客户端通过分布式管理节点得到分布式数据库节点的IP网络地址，
得到地址以后，客户端再连接数据库节点
，得到具体的数据，
分布式管理节点通过选举产生，也就是第一次启动的服务器节点，同时也能存储数据库数据。
本论文所述分布式数据库系统JSQL在分布式环境下具有两种节点，客户端节点和分布式数据库集群节点。客户端节点是用来连接分布式集群的，在系统中，可以用mysql节点来连接分布式数据库系统。在分布式数据库集群中，根据功能可以分为分布式管理节点和分布式数据库节点，在一个分布式系统中，只有一个分布式管理节点，其是通过选举产生的。当一个分布式管理节点失败的时候，通过选举选择其他的分布式数据节点作为管理节点，剩下的节点作为分布式数据库节点，用来存储具体的数据。在JSQL中，每个分布式管理节点都是独立的，可以自己管理其本地局部数据，通过和其他节点连接，可以动态扩展系统整体的读写性能。
。本系统的架构图如图\ref{pic4/jiagou}所示。
\pic[htbp]{系统总体架构图}{}{pic4/jiagou}
本系统中，客户端是用户发送命令的终端设备。
分布式管理节点收到客户端请求以后，
返回给客户端数据库节点的地址，然后客户端再连接数据库节点，
分布式数据库节点负责对客户端的请求消息进行处
理，并将处理后的响应消息返回给客户端。
在系统中，数据因为在不同的计算机上面都有备份，所以不存在丢失的危险。
\subsection{系统功能设计}
在需求分析和架构设计的基础之上，按照系统的节点对其进行功能划分，解决每个节点具有什么样的功能，每个功能由哪些模块组成。系统可以分为客户端和服务器两个功能节点，它们的主要功能模块如图\ref{pic4/mokuai}所示。
\pic[htbp]{系统模块划分}{}{pic4/mokuai}

在图\ref{pic4/mokuai}中，
分布式管理节点有元数据管理模块和审计界面功能模块这两个功能模块。
以下是对它们的更详细的介绍：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 元数据管理模块管理服务器的所有元数据，包括每个数据库节点的
	IP地址和端口号。分布式管理节点利用这些元数据来完成分布式的负载均衡算法，为客户端选择合适的
	分布式数据库节点。
	\item 审计界面管理模块对管理员使用，它可以让管理员管理所有的数据节点。
	审计功能除了审计界面以外，还包括分布式数据库节点的审计数据库，而审计数据库本身存储在系统内
	只有结合了分布式数据库的审计模块和分布式管理节点的审计模块，管理员才能对分布式系统进行审计管理。
\end{enumerate}

分布式数据库节点由审计数据库模块、数据库功能模块、集群功能模块组成，
 下面分别对 3 个模块的功能进行介绍。
 \begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
 	\item 审计数据库模块用来收集所有的日志信息，作为审计使用。
 	所有的数据库节点在接受到数据更改请求以后，就会把这些日志信息发送到审计数据库。
 	然后分布式管理节点就能利用这个数据为管理员提供审计功能。
 	\item 数据库功能模块完成具体的数据库功能。为用户提供操作接口，数据库功能模块可以分为网络模块，协议模块，解析模块和存储模块。在收到用户的请求命令以后。数据库功能模块就会对用户返回正确的信息。
 	\item 集群功能实现每个数据库节点的通信。本系统利用Hazelcast实现了数据库的集群。每个分布式数据库节点的数据都能自动同步。同时，利用分布式多版本并发控制技术解决了数据的一致性问题。
 \end{enumerate}
\section{客户端模块设计}
分布式数据库系统应该能够为客户端选择合适的网络存取路线，选择合适的分布式集群节点，在节点发生变化的时候，还能动态的调整分配和连接策略。本文采用的分布式管理节点较好地满足了这两点。分布式管理节点存储
所有数据库节点的元数据信息，实现了分布式负载均衡算法。
在分布式数据库系统中，负载均衡的功能是非常重要的，每个节点的性能和存储容量都不一样，选择的负载均衡算法必须要考虑到这些节点的差异，均衡的为客户端选择最合适的集群节点，这样才能利于系统整体性能的提高。分布式管理节点实现了负载均衡功能，
所以当我们想要使用负载均衡的时候我们必须要先连接管理节点，再连接数据库节点。
客户端连接的流程图如图\ref{pic4/lianjielc}所示。
\pic[htbp]{客户端连接流程图}{}{pic4/lianjielc}
每个流程解释如下：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 首先客户端连接到分布式管理节点，管理节点返回给客户端
	正确的数据库节点的地址。
	\item 然后客户端连接到正确的数据库节点。
	\item 最后数据库节点返回给客户端具体的数据。
\end{enumerate}
当然我们也可以直接连接分布式数据库节点，其中的数据会自动同步到其他的分布式数据库节点，这样可以直接用Mysql的客户端，减少用户的使用成本。
使用Mysql客户端，可以执行几乎所有的Mysql命令。当存储结构化数据的时候，在用户看来，分布式数据库节点就像一个Mysql数据库服务器一样。只是本系统能自动同步每个分布式数据库节点的数据。
\section{分布式管理模块}
要实现负载均衡和其他管理功能，只实现客户端是不够的。还需要一个分布式管理节点。
分布式管理模块存储所有数据库节点的元数据和实现负载均衡算法，
当启动分布式管理节点的时候，它会去查找所有的数据库节点，
然后存储到数据库里面保存。
分布式管理节点的启动流程图如图\ref{pic4/fenbushiguanli}所示。
\pic[htbp]{分布式管理节点初始化过程}{}{pic4/fenbushiguanli}

分布式管理节点和分布式数据库节点一样，都是服务器端的节点，都实现了同一个分布式功能。他们之间可以通过多播通信来交换信息。分布式管理节点得到这些信息以后。就能实现正确的负载均衡算法来选择合适的分布式数据库节点。
分布式管理节点初始化成功以后，客户端就可以通过自己开发的基于JDBC的客户端来连接后端的分布式数据库节点，发送数据查询命令。
\section{数据库功能模块详细设计}
作为一个分布式数据库系统，其首要的功能就是数据库功能，也就是能完成对数据的存储和操纵。分布式数据库系统接收到客户端的命令，然后解析命令，为客户端完成数据操纵，最后返回结果给客户端。
在数据库功能中，数据的增加、删除。修改和查询是其最主要的功能
。下面设计出每个数据库功能的操作处理流程。
\subsection{数据库功能操作流程设计}
\subsubsection{新增数据过程}
第一步，客户端首先连接分布式管理节点，由分布式管理节点返回客户端的连接会话信息，客户端得到服务器的地址。
第二步：客户端连接具体的数据库节点，发送新增数据请求，请求发送到具体的数据库节点。
数据库节点经过网络模块和通信模块，得到请求信息以后，调用数据库引擎的接口，
得到具体的数据，返回给客服。
\subsubsection{数据查询和修改过程}
第一步：客户端首先连接分布式管理节点，由分布式管理节点返回客户端的连接会话信息，客户端得到服务器的地址。
第二步：客户端连接具体的数据库节点，发送新增数据请求，请求发送到具体的数据库节点。
数据库节点经过网络模块和通信模块，得到请求信息以后，调用数据库引擎的接口，
得到具体的数据，返回给客户端。
\subsubsection{数据删除过程}
第一步：客户端首先连接分布式管理节点，由分布式管理节点返回客户端的连接会话信息，客户端得到服务器的地址。
第二步：客户端连接具体的数据库节点，发送新增数据请求，请求发送到具体的数据库节点。
数据库节点经过网络模块和通信模块，得到请求信息以后，调用数据库引擎的接口，
删除具体的数据，返回给客服操作成功消息。

数据库模块是本系统的主要开发模块，其详细模块图如图\ref{pic4/shujuku}所示。
\pic[htbp]{数据库功能模块图}{}{pic4/shujuku}
下面对每个功能模块进行详细的说明。
\subsection{网络模块设计}
所有的服务软件都需要实现网络模块，这样才能连接客户端的请求。
JSQL用java语言开发，主要用到的是java的网络开发模块。
但是直接用java语言开发网络功能非常的麻烦，
所以本文基于Netty来开发直接的网络模块。具体的网络实现，包括
线程池的规划都按照Netty的建议来开发。Netty的线程模型如图\ref{netty}所示。
\pic[htbp]{Netty线程模型}{}{netty}
根据图\ref{netty}所示，netty主要有三种线程：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 主线程池主要接受客户端的网络连接请求，当主线程接受到客户端的请求以后，就可以把客户端的请求交个从线程池来处理。这样主线程就可以接受更多的其他客户端的连接请求。使得服务器的吞吐量大大的提高。
	\item 从线程从主线程得到客户端的连接以后，执行具体的读取操作。如果需要执行其他的事务逻辑，比如说读取磁盘，那么就需要把这个请求发送给工作线程来处理，这样客户端才不会因为从线程的忙碌而堵塞。
	\item 工作线程主要用来执行时间消耗比较大的任何，比如任何和磁盘文件有关的操作都应该放在工作线程来处理。
\end{enumerate}
通过使用合适的线程模型，服务器具有很高的吞吐量，能接受成千上万的客户端连接。在设计系统的网络功能的时候，通过选择合适的框架和线程模型，设计出高性能的网络功能模块。
\subsection{通信协议设计}
每个服务器和客户端通信都要实现自己的通信协议，考虑到mysql使用的广泛性
。jsql采用mysql的通信协议。这样就不用自己开发协议了。在mysql服务器客户端交互生命过程中，主要有握手阶段和命令执行阶段。当客户端通过网络接口连接服务器的时候，握手阶段就开始了，在服务器对客户端进行身份和权限检查以后，双方就会进入命令阶段。在mysql客户端和服务器端的交互生命过程中，一共有握手和命令执行两个阶段。握手节点开始客户端的认证和双方的能力交互，命令阶段就是客户端向服务器发送命令，服务器执行命令然后客户端结果的执行阶段。

\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item 握手认证阶段\\
	当客户端通过网络连接服务器的时候就进入握手阶段，其交互过程如下：
	\begin{enumerate}
		\item 服务器发送给客户端握手初始化报文。
		\item 客户端回复服务器端登陆认证报文。
		\item 服务器发送给客户端认证结果报文。
	\end{enumerate}
	\item 命令执行阶段\\
	在服务器认证客户端成功后，双方会进入命令执行阶段，命令执行阶段的交互过程如下：
	\begin{enumerate}
		\item 	客户端发送服务器执行命令报文。
		\item 服务器发送给客户端命令执行结果。
	\end{enumerate}
\end{enumerate}

MySQL客户端与服务器之间的完整交互过程如图\ref{mysqljh}所示。
\pic[htbp]{协议交互流程图}{}{mysqljh}

在mysql的客户端和服务器的交互过程中，都是通过发送网络数据包来通信。每个数据包分为数据包头部和具体数据两个部分，数据报文的头部说明数据包的大小和序列号信息，数据部分则是具体的数据。在每个数据库报文头中都有两个字节用于表明实际数据的长度。
在报文头中还有一个关键字段就是序列号，在每次客户端服务器连接过程中，序列号就会被初始化为0。
在每个数据包的后面就是具体的报文数据，其具体的内容和报文类型有关，可以报考请求的内容、服务器响应的数据和其他的服务器操纵命令，这部分的长度由每个数据包的头部指定。
\subsection{SQL引擎设计}
SQL引擎模块就是对客户端发送过来的SQL语句进行语法和语意解析，理解客户端的操作目的。
终于成本和性能的考虑，在设计SQL引擎功能的时候，
论文选择基于成熟的开源框架Druid。SQL的解析流程如图\ref{pic4/sqljx}所示。
\pic[htbp]{SQL解析流程图}{}{pic4/sqljx}
SQL引擎层从协议层解析到语句以后，就要对这个语句进行解析，才能交给下面的存储引擎处理具体的请求。解析模块首先对语句进行词法分析和语法分析，得到抽象语法树，然后用访问者模式去遍历抽象语法树，得到我们需要的数据结构。这个结构被封装成类，每种语句都有不同的类对应。得到语句类型以后，我们就可以对他进行具体的分析和处理。最后交个存储引擎层处理具体的数据操纵。
\subsection{存储引擎设计}
存储引擎是数据库系统最重要的功能部件，存储引擎的功能就是为数据选择合适的存储组织结构，使得其更加高效的操作数据，不同数据库系统都有其特有的存储引擎。
每种存储引擎底层都基于一种数据结构。比如常用的哈希表结构和B+树结构。
本系统采用了一种NoSQL数据库引擎，这样可以结合非关系型数据库的优点。在OrientDB这个存储引擎基础之上，封装关系型的操作。完成关系型表和NoSQL数据库的转化。对上一层来说，我们提供了关系型存储引擎的接口调用。在存储引擎的底层，我们调用OrientDB的接口来完成具体的功能。这样能结合关系型操作的便利和非关系型数据库的优点。
\section{集群架构详细设计}
要实现集群功能，肯定要用到网络功能，
还要考虑各种不可靠的因素。
为了系统的稳定性和可靠性，
本文用到了一个开源的分布式的开发框架hazelcast，
基于hazelcast的应用程序的结构图如图\ref{hazelcast}所示。
\pic[htbp]{集群架构图}{}{hazelcast}
分布式数据库节点和分布式管理节点都嵌入了Hazelcast模块，
这样分布式管理节点就能很容易的得到每个数据库节点的详细信息，
直接调用框架的接口就可以得到这些信息。利用hazelcast的分布式数据结构，论文设计了分布式系统的多主分布式架构，在后面的具体实现部分会给出详细说明。

hazelcast分布式原理如图\ref{pic4/fenbusyl}所示。
\pic[htbp]{集群架构图}{}{pic4/fenbusyl}
在分布式数据库集群中，不用设计主节点，集群会自己发现和设置主节点。
在一个集群中，最先启动的计算机就是主节点，主节点拥有其他所有节点的信息。
当其他节点启动的时候，通过多播技术，加入多播网络。主节点发现以后，就会把自己的信息和集群所有其他计算机的信息发送给这个新的计算机，同时更新集群的元数据。当第一个主节点关掉的时候，再一次启动的计算机就自动成为主节点。
这样就不需要用户频繁的设置和更新元数据。分布式数据库集群在增加和删除节点的时候，不需要任何人为的干预，集群能够动态增加分布式数据库集群节点。
\section{审计模块详细设计}
审计模块部署在管理计算机和分布式管理节点上面。管理员通过管理计算机连接分布式管理节点就可以管理所有的数据。监控所有数据的更改情况。
图\ref{jiankong}显示了审计模块的实现层次结构图。从上大下一共可以分为下面4个模块：
\begin{enumerate}[fullwidth,itemindent=2em,listparindent=2em]
	\item grafana可视化和报警模块，主要用到了开源的图形框架，来显示底层的审计数据，
	同时也可以让用户设定预警数据，
	这样以后就可以在一定的情况下向用户报警。
	\item elasticsearch模块用来存储监控数据，监控数据为了登陆日志和sql执行日志
	我们需要更改它的源代码才能用来作为审计数据库，
	因为审计数据库不能随意的更改和删除，只能查询和增加。
	\item JSQL接口层，主要是为上面和下面的各层提供连接功能，
	为上面层提供数据接口，为下面层提供显示接口，使得更加容易使用。
	\item 本地日志层，主要是在文件系统中存储所有需要的日志记录，这样可以随时和审计数据库的数据来
	对比。审计数据的安全和一致性。
\end{enumerate}
\pic[htbp]{监控模块}{}{jiankong}
\section{本章小结}
任何软件系统只有经过仔细的系统设计，在编码阶段才能提前减少不必要的错误。
在本章分别对系统进行了总体设计和详细设计，在总体设计部分，首先对分布式数据库系统的部署架构进行说明，然后针对每个节点的功能进行模块划分。在系统的详细设计阶段，对总体设计阶段所划分的模块进行详细设计，包括客户端模块、分布式管理模块、数据库模块、集群架构模块和审计模块。对系统进行详细设计方便系统的编码和测试。